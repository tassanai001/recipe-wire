# Story 2.5: Frontend Authentication Pages & State Management

**Epic:** Epic 2 - Authentication & User System  
**Story ID:** 2.5  
**Priority:** High  
**Estimate:** 8 Story Points  
**Sprint:** Sprint 2-3 (Week 3-4)

---

## Status

**Draft**

---

## Story

**As a** user,  
**I want** intuitive signup and login pages,  
**so that** I can easily create an account or access my existing account

---

## Acceptance Criteria

1. Signup page created at `/signup`:
   - Form fields: email, password, confirm password, display name
   - Client-side validation matches API requirements
   - Password strength indicator
   - Submit button calls signup API
   - Success redirects to dashboard
   - Error messages displayed clearly
2. Login page created at `/login`:
   - Form fields: email, password
   - Submit button calls login API
   - Success redirects to dashboard
   - Error messages displayed clearly
   - Link to signup page
3. Auth state management with Zustand:
   - Store: user, accessToken, isAuthenticated
   - Actions: login, logout, setUser
   - Persist tokens in localStorage (with security considerations)
4. API client configured with React Query:
   - Automatic token attachment to requests
   - Token refresh on 401 errors
   - Logout on refresh failure
5. Protected route wrapper created:
   - Redirects to login if not authenticated
   - Shows loading state during auth check
6. Navigation updated with auth-aware links:
   - Show "Login/Signup" when logged out
   - Show "Profile/Logout" when logged in
7. Responsive design for mobile and desktop
8. Accessibility: proper labels, keyboard navigation, ARIA attributes

---

## Tasks / Subtasks

- [ ] **Update Auth Store** (AC: 3)
  - [ ] Update `src/store/auth.store.ts` from Story 1.5
  - [ ] Add user state with User type
  - [ ] Add accessToken and refreshToken state
  - [ ] Implement login action (set user, tokens, isAuthenticated)
  - [ ] Implement logout action (clear all state)
  - [ ] Implement setUser action
  - [ ] Configure persist middleware for localStorage
  - [ ] Test store actions

- [ ] **Create Auth API Functions** (AC: 1, 2)
  - [ ] Create `src/lib/api/auth.api.ts`
  - [ ] Implement signup function calling POST /v1/auth/signup
  - [ ] Implement login function calling POST /v1/auth/login
  - [ ] Implement refresh function calling POST /v1/auth/refresh
  - [ ] Implement getProfile function calling GET /v1/me
  - [ ] Use apiClient from Story 1.5
  - [ ] Export all functions

- [ ] **Configure API Client with Token Interceptor** (AC: 4)
  - [ ] Update `src/lib/api/client.ts`
  - [ ] Add request interceptor to attach accessToken from store
  - [ ] Add response interceptor to handle 401 errors
  - [ ] Implement automatic token refresh on 401
  - [ ] Logout user if refresh fails
  - [ ] Retry original request after refresh

- [ ] **Create Auth Hooks with React Query** (AC: 4)
  - [ ] Create `src/hooks/use-auth.ts`
  - [ ] Create useSignup mutation hook
  - [ ] Create useLogin mutation hook
  - [ ] Create useLogout mutation hook
  - [ ] Handle success/error states
  - [ ] Integrate with auth store
  - [ ] Export hooks

- [ ] **Create Signup Page** (AC: 1, 7, 8)
  - [ ] Create `src/app/(auth)/signup/page.tsx`
  - [ ] Use shadcn/ui Form, Input, Button, Card components
  - [ ] Add form fields: email, password, confirmPassword, displayName
  - [ ] Use React Hook Form for form management
  - [ ] Add Zod validation schema (client-side)
  - [ ] Implement password strength indicator
  - [ ] Call useSignup hook on submit
  - [ ] Redirect to dashboard on success
  - [ ] Display error messages
  - [ ] Make responsive
  - [ ] Add proper ARIA labels

- [ ] **Create Login Page** (AC: 2, 7, 8)
  - [ ] Create `src/app/(auth)/login/page.tsx`
  - [ ] Use shadcn/ui Form, Input, Button, Card components
  - [ ] Add form fields: email, password
  - [ ] Use React Hook Form for form management
  - [ ] Add Zod validation schema
  - [ ] Call useLogin hook on submit
  - [ ] Redirect to dashboard on success
  - [ ] Display error messages
  - [ ] Add link to signup page
  - [ ] Make responsive
  - [ ] Add proper ARIA labels

- [ ] **Create Password Strength Indicator** (AC: 1)
  - [ ] Create `src/components/auth/password-strength.tsx`
  - [ ] Calculate password strength (weak/medium/strong)
  - [ ] Display visual indicator (color-coded bar)
  - [ ] Show strength label
  - [ ] Check for: length, letters, numbers, special chars
  - [ ] Make accessible

- [ ] **Create Protected Route Component** (AC: 5)
  - [ ] Create `src/components/auth/protected-route.tsx`
  - [ ] Check if user is authenticated from store
  - [ ] Show loading spinner while checking
  - [ ] Redirect to /login if not authenticated
  - [ ] Render children if authenticated
  - [ ] Store redirect URL for post-login navigation

- [ ] **Create Dashboard Page (Placeholder)** (AC: 1, 2)
  - [ ] Create `src/app/(dashboard)/dashboard/page.tsx`
  - [ ] Wrap with ProtectedRoute
  - [ ] Display welcome message with user name
  - [ ] Add placeholder content
  - [ ] This will be expanded in Epic 3

- [ ] **Update Navigation Component** (AC: 6)
  - [ ] Update `src/components/layout/navigation.tsx`
  - [ ] Check isAuthenticated from auth store
  - [ ] Show "Login" and "Sign Up" buttons when logged out
  - [ ] Show user name and "Logout" button when logged in
  - [ ] Add dropdown menu for user actions (Profile, Logout)
  - [ ] Implement logout functionality
  - [ ] Make responsive (mobile menu)

- [ ] **Create Auth Layout** (AC: 7)
  - [ ] Create `src/app/(auth)/layout.tsx`
  - [ ] Center form on page
  - [ ] Add background styling
  - [ ] Make responsive
  - [ ] Add RecipeWire logo/branding

- [ ] **Add Form Validation Messages** (AC: 1, 2, 8)
  - [ ] Display field-level errors below inputs
  - [ ] Display API errors at top of form
  - [ ] Use consistent error styling
  - [ ] Make error messages accessible (aria-describedby)
  - [ ] Clear errors on field change

- [ ] **Test Authentication Flow** (AC: 1-6)
  - [ ] Test signup with valid data
  - [ ] Test signup with invalid data (validation errors)
  - [ ] Test signup with duplicate email (API error)
  - [ ] Test login with valid credentials
  - [ ] Test login with invalid credentials
  - [ ] Test logout clears state
  - [ ] Test protected route redirects when not authenticated
  - [ ] Test protected route allows access when authenticated
  - [ ] Test token refresh on 401
  - [ ] Test navigation updates based on auth state

---

## Dev Notes

### Previous Story Insights
[Dependency: Story 2.1-2.4 - Backend Auth APIs]

Backend stories established:
- POST /v1/auth/signup endpoint
- POST /v1/auth/login endpoint (returns tokens)
- POST /v1/auth/refresh endpoint
- GET /v1/me endpoint (protected)
- JWT authentication with access and refresh tokens

This story creates the frontend UI and state management for authentication.

[Dependency: Story 1.5 - Setup Next.js Frontend Skeleton]

Story 1.5 established:
- Next.js 14 with App Router
- Zustand store (basic auth store)
- React Query configuration
- API client with Axios
- shadcn/ui components

This story expands the auth functionality.

### Auth Store Implementation
[Source: architecture/tech-stack.md#zustand-4]

**Updated auth store (src/store/auth.store.ts):**
```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface User {
  id: string
  email: string
  displayName: string
  bio?: string
  avatarUrl?: string
}

interface AuthState {
  user: User | null
  accessToken: string | null
  refreshToken: string | null
  isAuthenticated: boolean
  login: (user: User, accessToken: string, refreshToken: string) => void
  logout: () => void
  setUser: (user: User) => void
  setAccessToken: (token: string) => void
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,
      login: (user, accessToken, refreshToken) =>
        set({
          user,
          accessToken,
          refreshToken,
          isAuthenticated: true
        }),
      logout: () =>
        set({
          user: null,
          accessToken: null,
          refreshToken: null,
          isAuthenticated: false
        }),
      setUser: (user) => set({ user }),
      setAccessToken: (token) => set({ accessToken: token })
    }),
    {
      name: 'auth-storage'
    }
  )
)
```

### API Client with Token Interceptor
[Source: prd/epic-2-authentication.md#story-2.5]

**Updated API client (src/lib/api/client.ts):**
```typescript
import axios from 'axios'
import { useAuthStore } from '@/store/auth.store'

const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/v1',
  headers: {
    'Content-Type': 'application/json'
  }
})

// Request interceptor - attach token
apiClient.interceptors.request.use((config) => {
  const token = useAuthStore.getState().accessToken
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// Response interceptor - handle 401 and refresh token
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config

    // If 401 and not already retried
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true

      try {
        const refreshToken = useAuthStore.getState().refreshToken
        if (!refreshToken) {
          throw new Error('No refresh token')
        }

        // Call refresh endpoint
        const { data } = await axios.post(
          `${process.env.NEXT_PUBLIC_API_URL}/v1/auth/refresh`,
          { refreshToken }
        )

        // Update access token in store
        useAuthStore.getState().setAccessToken(data.accessToken)

        // Retry original request with new token
        originalRequest.headers.Authorization = `Bearer ${data.accessToken}`
        return apiClient(originalRequest)
      } catch (refreshError) {
        // Refresh failed, logout user
        useAuthStore.getState().logout()
        window.location.href = '/login'
        return Promise.reject(refreshError)
      }
    }

    return Promise.reject(error)
  }
)

export default apiClient
```

### Auth API Functions
[Source: architecture/source-tree.md#frontend-structure]

**Auth API (src/lib/api/auth.api.ts):**
```typescript
import apiClient from './client'
import type { SignupDto, LoginDto, User } from '@recipe-wire/types'

export async function signup(data: SignupDto) {
  const response = await apiClient.post('/auth/signup', data)
  return response.data
}

export async function login(data: LoginDto) {
  const response = await apiClient.post('/auth/login', data)
  return response.data
}

export async function refresh(refreshToken: string) {
  const response = await apiClient.post('/auth/refresh', { refreshToken })
  return response.data
}

export async function getProfile() {
  const response = await apiClient.get('/me')
  return response.data
}
```

### Auth Hooks with React Query
[Source: architecture/tech-stack.md#react-query-5]

**Auth hooks (src/hooks/use-auth.ts):**
```typescript
import { useMutation } from '@tanstack/react-query'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/store/auth.store'
import * as authApi from '@/lib/api/auth.api'
import type { SignupDto, LoginDto } from '@recipe-wire/types'

export function useSignup() {
  const router = useRouter()
  const login = useAuthStore((state) => state.login)

  return useMutation({
    mutationFn: authApi.signup,
    onSuccess: (data) => {
      // Note: Signup doesn't return tokens in our API
      // User needs to login after signup
      router.push('/login')
    }
  })
}

export function useLogin() {
  const router = useRouter()
  const login = useAuthStore((state) => state.login)

  return useMutation({
    mutationFn: authApi.login,
    onSuccess: (data) => {
      login(data.user, data.accessToken, data.refreshToken)
      router.push('/dashboard')
    }
  })
}

export function useLogout() {
  const router = useRouter()
  const logout = useAuthStore((state) => state.logout)

  return useMutation({
    mutationFn: async () => {
      // Optional: Call logout endpoint if implemented
      logout()
    },
    onSuccess: () => {
      router.push('/login')
    }
  })
}
```

### Signup Page Implementation
[Source: prd/epic-2-authentication.md#story-2.5]

**Signup page (src/app/(auth)/signup/page.tsx):**
```typescript
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { SignupSchema } from '@recipe-wire/types'
import { useSignup } from '@/hooks/use-auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card } from '@/components/ui/card'
import { Form, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form'
import PasswordStrength from '@/components/auth/password-strength'
import Link from 'next/link'

export default function SignupPage() {
  const signup = useSignup()
  const form = useForm({
    resolver: zodResolver(SignupSchema.extend({
      confirmPassword: z.string()
    }).refine((data) => data.password === data.confirmPassword, {
      message: "Passwords don't match",
      path: ['confirmPassword']
    }))
  })

  const onSubmit = (data) => {
    signup.mutate(data)
  }

  return (
    <div className="flex min-h-screen items-center justify-center">
      <Card className="w-full max-w-md p-8">
        <h1 className="text-2xl font-bold mb-6">Create Account</h1>
        
        {signup.isError && (
          <div className="bg-red-50 text-red-600 p-3 rounded mb-4">
            {signup.error.response?.data?.message || 'Signup failed'}
          </div>
        )}

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="email"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Email</FormLabel>
                  <Input type="email" {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="displayName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Display Name</FormLabel>
                  <Input {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="password"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Password</FormLabel>
                  <Input type="password" {...field} />
                  <PasswordStrength password={field.value} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="confirmPassword"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Confirm Password</FormLabel>
                  <Input type="password" {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <Button type="submit" className="w-full" disabled={signup.isPending}>
              {signup.isPending ? 'Creating account...' : 'Sign Up'}
            </Button>
          </form>
        </Form>

        <p className="mt-4 text-center text-sm">
          Already have an account?{' '}
          <Link href="/login" className="text-primary hover:underline">
            Log in
          </Link>
        </p>
      </Card>
    </div>
  )
}
```

### Login Page Implementation
[Source: prd/epic-2-authentication.md#story-2.5]

**Login page (src/app/(auth)/login/page.tsx):**
```typescript
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { LoginSchema } from '@recipe-wire/types'
import { useLogin } from '@/hooks/use-auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card } from '@/components/ui/card'
import { Form, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form'
import Link from 'next/link'

export default function LoginPage() {
  const login = useLogin()
  const form = useForm({
    resolver: zodResolver(LoginSchema)
  })

  const onSubmit = (data) => {
    login.mutate(data)
  }

  return (
    <div className="flex min-h-screen items-center justify-center">
      <Card className="w-full max-w-md p-8">
        <h1 className="text-2xl font-bold mb-6">Log In</h1>
        
        {login.isError && (
          <div className="bg-red-50 text-red-600 p-3 rounded mb-4">
            {login.error.response?.data?.message || 'Login failed'}
          </div>
        )}

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="email"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Email</FormLabel>
                  <Input type="email" {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="password"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Password</FormLabel>
                  <Input type="password" {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <Button type="submit" className="w-full" disabled={login.isPending}>
              {login.isPending ? 'Logging in...' : 'Log In'}
            </Button>
          </form>
        </Form>

        <p className="mt-4 text-center text-sm">
          Don't have an account?{' '}
          <Link href="/signup" className="text-primary hover:underline">
            Sign up
          </Link>
        </p>
      </Card>
    </div>
  )
}
```

### Protected Route Component
[Source: prd/epic-2-authentication.md#story-2.5]

**Protected route (src/components/auth/protected-route.tsx):**
```typescript
'use client'

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/store/auth.store'

export default function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const router = useRouter()
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
    } else {
      setIsLoading(false)
    }
  }, [isAuthenticated, router])

  if (isLoading) {
    return <div className="flex items-center justify-center min-h-screen">Loading...</div>
  }

  return <>{children}</>
}
```

### Password Strength Indicator
[Source: prd/epic-2-authentication.md#story-2.5]

**Password strength component:**
```typescript
export default function PasswordStrength({ password }: { password: string }) {
  const strength = calculateStrength(password)
  
  return (
    <div className="mt-2">
      <div className="flex gap-1">
        {[1, 2, 3, 4].map((level) => (
          <div
            key={level}
            className={`h-1 flex-1 rounded ${
              level <= strength ? getColor(strength) : 'bg-gray-200'
            }`}
          />
        ))}
      </div>
      <p className="text-xs mt-1">{getLabel(strength)}</p>
    </div>
  )
}

function calculateStrength(password: string): number {
  let strength = 0
  if (password.length >= 8) strength++
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++
  if (/[0-9]/.test(password)) strength++
  if (/[^a-zA-Z0-9]/.test(password)) strength++
  return strength
}
```

### Security Considerations
[Source: prd/epic-2-authentication.md#security-considerations]

**Token storage:**
- Tokens stored in localStorage via Zustand persist
- Consider httpOnly cookies for Phase 2 (more secure)
- Never log tokens
- Clear tokens on logout

**XSS Protection:**
- Sanitize user input
- Use React's built-in XSS protection
- Implement Content Security Policy (Phase 2)

### Testing

Manual testing required for this frontend story:
1. Test signup flow end-to-end
2. Test login flow end-to-end
3. Test logout clears state
4. Test protected routes redirect
5. Test token refresh on 401
6. Test responsive design
7. Test accessibility with keyboard
8. Test error handling

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent during implementation_

### Debug Log References
_To be filled by Dev Agent during implementation_

### Completion Notes List
_To be filled by Dev Agent during implementation_

### File List
_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
