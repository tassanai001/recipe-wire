# Story 2.6: User Profile Page & Edit Functionality

**Epic:** Epic 2 - Authentication & User System  
**Story ID:** 2.6  
**Priority:** Medium  
**Estimate:** 5 Story Points  
**Sprint:** Sprint 2-3 (Week 3-4)

---

## Status

**Draft**

---

## Story

**As a** logged-in user,  
**I want** a profile page where I can view and edit my information,  
**so that** I can keep my account up to date

---

## Acceptance Criteria

1. Profile page created at `/profile`:
   - Protected route (requires authentication)
   - Displays current user information:
     - Avatar (placeholder if not set)
     - Display name
     - Email (read-only)
     - Bio
   - "Edit Profile" button
2. Edit profile modal/form:
   - Fields: display name, bio, avatar URL
   - Pre-filled with current values
   - Client-side validation
   - Submit calls `PATCH /v1/me` API
   - Success updates UI and shows success message
   - Cancel button discards changes
3. Avatar upload functionality (uses local upload):
   - File picker for image selection
   - Preview before upload
   - Calls upload API, then updates avatarUrl
   - Shows upload progress
4. Responsive design
5. Loading states during API calls
6. Error handling with user-friendly messages
7. Accessibility compliant

---

## Tasks / Subtasks

- [ ] **Create Profile API Functions** (AC: 1, 2)
  - [ ] Update `src/lib/api/auth.api.ts`
  - [ ] Implement updateProfile function calling PATCH /v1/me
  - [ ] Add proper TypeScript types
  - [ ] Export function

- [ ] **Create Upload API Functions** (AC: 3)
  - [ ] Create `src/lib/api/upload.api.ts`
  - [ ] Implement uploadProfileImage function calling POST /v1/uploads/profiles
  - [ ] Handle FormData for file upload
  - [ ] Return uploaded file URL
  - [ ] Export function

- [ ] **Create Profile Hooks** (AC: 1, 2)
  - [ ] Create `src/hooks/use-profile.ts`
  - [ ] Create useProfile query hook (fetches GET /v1/me)
  - [ ] Create useUpdateProfile mutation hook
  - [ ] Create useUploadAvatar mutation hook
  - [ ] Handle optimistic updates
  - [ ] Integrate with auth store
  - [ ] Export hooks

- [ ] **Create Profile Page** (AC: 1, 4, 5, 7)
  - [ ] Create `src/app/(dashboard)/profile/page.tsx`
  - [ ] Wrap with ProtectedRoute
  - [ ] Use useProfile hook to fetch user data
  - [ ] Display avatar (with fallback)
  - [ ] Display display name, email, bio
  - [ ] Add "Edit Profile" button
  - [ ] Show loading skeleton while fetching
  - [ ] Make responsive
  - [ ] Add proper ARIA labels

- [ ] **Create Edit Profile Dialog** (AC: 2, 4, 5, 6, 7)
  - [ ] Create `src/components/profile/edit-profile-dialog.tsx`
  - [ ] Use shadcn/ui Dialog component
  - [ ] Use React Hook Form for form management
  - [ ] Add fields: displayName, bio, avatarUrl
  - [ ] Pre-fill with current values
  - [ ] Add Zod validation (client-side)
  - [ ] Call useUpdateProfile hook on submit
  - [ ] Show success toast on success
  - [ ] Show error message on failure
  - [ ] Close dialog on success
  - [ ] Make accessible

- [ ] **Create Avatar Component** (AC: 1)
  - [ ] Create `src/components/profile/avatar.tsx`
  - [ ] Use shadcn/ui Avatar component
  - [ ] Display user avatar image if available
  - [ ] Show initials fallback if no avatar
  - [ ] Support different sizes (sm, md, lg)
  - [ ] Make accessible with alt text

- [ ] **Create Avatar Upload Component** (AC: 3, 5, 6)
  - [ ] Create `src/components/profile/avatar-upload.tsx`
  - [ ] Add file input with image type filter
  - [ ] Preview selected image before upload
  - [ ] Validate file size (max 3MB)
  - [ ] Validate file type (jpeg, png, webp)
  - [ ] Call useUploadAvatar hook on upload
  - [ ] Show upload progress indicator
  - [ ] Update avatarUrl in form after upload
  - [ ] Handle upload errors
  - [ ] Make accessible

- [ ] **Implement Optimistic Updates** (AC: 2)
  - [ ] Configure React Query optimistic updates
  - [ ] Update UI immediately on submit
  - [ ] Revert on error
  - [ ] Show loading state during actual update
  - [ ] Invalidate profile query on success

- [ ] **Create Success Toast** (AC: 2)
  - [ ] Install/configure toast library (shadcn/ui toast)
  - [ ] Show success message on profile update
  - [ ] Auto-dismiss after 3 seconds
  - [ ] Make accessible

- [ ] **Add Loading States** (AC: 5)
  - [ ] Show skeleton loader while fetching profile
  - [ ] Show spinner in submit button during update
  - [ ] Show progress bar during avatar upload
  - [ ] Disable form during submission

- [ ] **Add Error Handling** (AC: 6)
  - [ ] Display field-level validation errors
  - [ ] Display API errors in dialog
  - [ ] Handle network errors gracefully
  - [ ] Show user-friendly error messages
  - [ ] Make errors accessible

- [ ] **Update Navigation** (AC: 1)
  - [ ] Add "Profile" link to user dropdown in navigation
  - [ ] Link to /profile page
  - [ ] Highlight active route

- [ ] **Test Profile Functionality** (AC: 1-7)
  - [ ] Test profile page loads user data
  - [ ] Test edit dialog opens with pre-filled data
  - [ ] Test updating display name
  - [ ] Test updating bio
  - [ ] Test avatar upload flow
  - [ ] Test validation errors display
  - [ ] Test API errors display
  - [ ] Test optimistic updates
  - [ ] Test responsive design
  - [ ] Test keyboard navigation
  - [ ] Test screen reader compatibility

---

## Dev Notes

### Previous Story Insights

[Dependency: Story 2.4 - User Profile Management API]

Story 2.4 established:

- GET /v1/me endpoint (returns user profile)
- PATCH /v1/me endpoint (updates profile)
- Validation for displayName, bio, avatarUrl

This story creates the frontend UI for profile management.

[Dependency: Story 2.5 - Frontend Authentication Pages]

Story 2.5 established:

- Auth state management with Zustand
- Protected route wrapper
- API client with token interceptor
- React Query hooks pattern

This story follows the same patterns.

[Dependency: Story 1.6 - Setup Local File Upload Infrastructure]

Story 1.6 established:

- POST /v1/uploads/profiles endpoint
- File validation (type, size)
- Static file serving at /uploads/profiles/

This story uses the upload endpoint for avatar images.

### Profile API Functions

[Source: architecture/source-tree.md#frontend-structure]

**Update auth API (src/lib/api/auth.api.ts):**

```typescript
export async function updateProfile(data: UpdateProfileDto) {
  const response = await apiClient.patch('/me', data)
  return response.data
}
```

**Upload API (src/lib/api/upload.api.ts):**

```typescript
import apiClient from './client'

export async function uploadProfileImage(file: File) {
  const formData = new FormData()
  formData.append('file', file)

  const response = await apiClient.post('/uploads/profiles', formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
  })

  return response.data
}
```

### Profile Hooks

[Source: architecture/tech-stack.md#react-query-5]

**Profile hooks (src/hooks/use-profile.ts):**

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { useAuthStore } from '@/store/auth.store'
import * as authApi from '@/lib/api/auth.api'
import * as uploadApi from '@/lib/api/upload.api'
import type { UpdateProfileDto } from '@recipe-wire/types'

export function useProfile() {
  return useQuery({
    queryKey: ['profile'],
    queryFn: authApi.getProfile,
    staleTime: 5 * 60 * 1000, // 5 minutes
  })
}

export function useUpdateProfile() {
  const queryClient = useQueryClient()
  const setUser = useAuthStore(state => state.setUser)

  return useMutation({
    mutationFn: authApi.updateProfile,
    onMutate: async newData => {
      // Optimistic update
      await queryClient.cancelQueries({ queryKey: ['profile'] })
      const previousProfile = queryClient.getQueryData(['profile'])

      queryClient.setQueryData(['profile'], (old: any) => ({
        ...old,
        ...newData,
      }))

      return { previousProfile }
    },
    onError: (err, newData, context) => {
      // Revert on error
      queryClient.setQueryData(['profile'], context?.previousProfile)
    },
    onSuccess: data => {
      // Update auth store
      setUser(data)
      // Invalidate and refetch
      queryClient.invalidateQueries({ queryKey: ['profile'] })
    },
  })
}

export function useUploadAvatar() {
  return useMutation({
    mutationFn: uploadApi.uploadProfileImage,
  })
}
```

### Profile Page Implementation

[Source: prd/epic-2-authentication.md#story-2.6]

**Profile page (src/app/(dashboard)/profile/page.tsx):**

```typescript
'use client'

import { useState } from 'react'
import { useProfile } from '@/hooks/use-profile'
import { Button } from '@/components/ui/button'
import { Card } from '@/components/ui/card'
import Avatar from '@/components/profile/avatar'
import EditProfileDialog from '@/components/profile/edit-profile-dialog'
import ProtectedRoute from '@/components/auth/protected-route'

function ProfilePageContent() {
  const { data: user, isLoading } = useProfile()
  const [isEditOpen, setIsEditOpen] = useState(false)

  if (isLoading) {
    return <div>Loading profile...</div>
  }

  return (
    <div className="container mx-auto py-8">
      <Card className="max-w-2xl mx-auto p-8">
        <div className="flex items-center gap-6 mb-6">
          <Avatar user={user} size="lg" />
          <div className="flex-1">
            <h1 className="text-2xl font-bold">{user.displayName}</h1>
            <p className="text-gray-600">{user.email}</p>
          </div>
          <Button onClick={() => setIsEditOpen(true)}>
            Edit Profile
          </Button>
        </div>

        {user.bio && (
          <div className="mb-4">
            <h2 className="font-semibold mb-2">Bio</h2>
            <p className="text-gray-700">{user.bio}</p>
          </div>
        )}

        <div className="text-sm text-gray-500">
          Member since {new Date(user.createdAt).toLocaleDateString()}
        </div>
      </Card>

      <EditProfileDialog
        user={user}
        open={isEditOpen}
        onOpenChange={setIsEditOpen}
      />
    </div>
  )
}

export default function ProfilePage() {
  return (
    <ProtectedRoute>
      <ProfilePageContent />
    </ProtectedRoute>
  )
}
```

### Edit Profile Dialog

[Source: prd/epic-2-authentication.md#story-2.6]

**Edit profile dialog (src/components/profile/edit-profile-dialog.tsx):**

```typescript
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { UpdateProfileSchema } from '@recipe-wire/types'
import { useUpdateProfile } from '@/hooks/use-profile'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Form, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form'
import { useToast } from '@/components/ui/use-toast'
import AvatarUpload from './avatar-upload'

export default function EditProfileDialog({ user, open, onOpenChange }) {
  const updateProfile = useUpdateProfile()
  const { toast } = useToast()
  const form = useForm({
    resolver: zodResolver(UpdateProfileSchema),
    defaultValues: {
      displayName: user.displayName,
      bio: user.bio || '',
      avatarUrl: user.avatarUrl || ''
    }
  })

  const onSubmit = async (data) => {
    try {
      await updateProfile.mutateAsync(data)
      toast({
        title: 'Profile updated',
        description: 'Your profile has been updated successfully.'
      })
      onOpenChange(false)
    } catch (error) {
      toast({
        title: 'Update failed',
        description: error.response?.data?.message || 'Failed to update profile',
        variant: 'destructive'
      })
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Edit Profile</DialogTitle>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <AvatarUpload
              currentAvatar={user.avatarUrl}
              onUploadComplete={(url) => form.setValue('avatarUrl', url)}
            />

            <FormField
              control={form.control}
              name="displayName"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Display Name</FormLabel>
                  <Input {...field} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="bio"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Bio</FormLabel>
                  <Textarea {...field} rows={4} />
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
              >
                Cancel
              </Button>
              <Button type="submit" disabled={updateProfile.isPending}>
                {updateProfile.isPending ? 'Saving...' : 'Save Changes'}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}
```

### Avatar Upload Component

[Source: prd/epic-2-authentication.md#story-2.6]

**Avatar upload (src/components/profile/avatar-upload.tsx):**

```typescript
'use client'

import { useState } from 'react'
import { useUploadAvatar } from '@/hooks/use-profile'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import Avatar from './avatar'

export default function AvatarUpload({ currentAvatar, onUploadComplete }) {
  const [preview, setPreview] = useState(currentAvatar)
  const [file, setFile] = useState<File | null>(null)
  const uploadAvatar = useUploadAvatar()

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0]
    if (!selectedFile) return

    // Validate file size (3MB)
    if (selectedFile.size > 3 * 1024 * 1024) {
      alert('File size must be less than 3MB')
      return
    }

    // Validate file type
    if (!['image/jpeg', 'image/png', 'image/webp'].includes(selectedFile.type)) {
      alert('Only JPEG, PNG, and WebP images are allowed')
      return
    }

    setFile(selectedFile)
    setPreview(URL.createObjectURL(selectedFile))
  }

  const handleUpload = async () => {
    if (!file) return

    try {
      const result = await uploadAvatar.mutateAsync(file)
      onUploadComplete(result.url)
      setFile(null)
    } catch (error) {
      alert('Upload failed. Please try again.')
    }
  }

  return (
    <div className="flex items-center gap-4">
      <Avatar src={preview} size="lg" />
      <div className="flex-1">
        <input
          type="file"
          accept="image/jpeg,image/png,image/webp"
          onChange={handleFileChange}
          className="hidden"
          id="avatar-upload"
        />
        <label htmlFor="avatar-upload">
          <Button type="button" variant="outline" asChild>
            <span>Choose Image</span>
          </Button>
        </label>
        {file && (
          <Button
            type="button"
            onClick={handleUpload}
            disabled={uploadAvatar.isPending}
            className="ml-2"
          >
            {uploadAvatar.isPending ? 'Uploading...' : 'Upload'}
          </Button>
        )}
        {uploadAvatar.isPending && (
          <Progress value={50} className="mt-2" />
        )}
      </div>
    </div>
  )
}
```

### Avatar Component

[Source: architecture/source-tree.md#frontend-structure]

**Avatar component (src/components/profile/avatar.tsx):**

```typescript
import { Avatar as AvatarUI, AvatarImage, AvatarFallback } from '@/components/ui/avatar'

export default function Avatar({ user, src, size = 'md' }) {
  const sizeClasses = {
    sm: 'h-8 w-8',
    md: 'h-12 w-12',
    lg: 'h-24 w-24'
  }

  const initials = user?.displayName
    ?.split(' ')
    .map((n) => n[0])
    .join('')
    .toUpperCase()
    .slice(0, 2) || '??'

  return (
    <AvatarUI className={sizeClasses[size]}>
      <AvatarImage src={src || user?.avatarUrl} alt={user?.displayName} />
      <AvatarFallback>{initials}</AvatarFallback>
    </AvatarUI>
  )
}
```

### Optimistic Updates

[Source: architecture/tech-stack.md#react-query-5]

**Optimistic update pattern:**

1. Cancel ongoing queries
2. Save previous data
3. Update cache immediately
4. On error: revert to previous data
5. On success: invalidate and refetch

This provides instant feedback to users while maintaining data consistency.

### Testing

Manual testing required:

1. Test profile page displays user data
2. Test edit dialog opens with pre-filled data
3. Test updating display name
4. Test updating bio
5. Test avatar upload (select, preview, upload)
6. Test file validation (size, type)
7. Test optimistic updates
8. Test error handling
9. Test responsive design
10. Test accessibility with keyboard and screen reader

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
