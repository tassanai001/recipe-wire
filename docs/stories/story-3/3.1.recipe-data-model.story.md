# Story 3.1: Recipe Data Model & Database Schema

**Epic:** Epic 3 - Recipe Management  
**Story ID:** 3.1  
**Priority:** High  
**Estimate:** 5 Story Points  
**Sprint:** Sprint 4-6 (Week 5-8)

---

## Status

**Draft**

---

## Story

**As a** developer,  
**I want** a complete recipe data model with all relationships,  
**so that** I can store and query recipe data efficiently

---

## Acceptance Criteria

1. Prisma schema updated with recipe-related models:
   - `Recipe` model with fields: id, ownerId, title, description, coverImageUrl, cookTimeMinutes, avgRating, ratingsCount, isPublished, createdAt, updatedAt
   - `RecipeStep` model: id, recipeId, stepNumber, instruction
   - `RecipeIngredient` model: id, recipeId, label
   - `Category` model: id, name
   - `RecipeCategory` junction table: id, recipeId, categoryId
2. Database relationships configured:
   - User → Recipes (one-to-many)
   - Recipe → Steps (one-to-many, cascade delete)
   - Recipe → Ingredients (one-to-many, cascade delete)
   - Recipe ↔ Categories (many-to-many via RecipeCategory)
3. Database indexes created on Recipe.title, Recipe.ownerId, Recipe.avgRating, Recipe.createdAt
4. Full-text search index on Recipe (title, description)
5. Migration created and applied successfully
6. Seed data script with sample categories

---

## Tasks / Subtasks

- [ ] **Design Recipe Model** (AC: 1)
  - [ ] Define Recipe model with all fields
  - [ ] Set UUID for id and ownerId
  - [ ] Add title (String, required)
  - [ ] Add description (String, optional)
  - [ ] Add coverImageUrl (String, optional)
  - [ ] Add cookTimeMinutes (Int, required)
  - [ ] Add avgRating (Decimal, default 0)
  - [ ] Add ratingsCount (Int, default 0)
  - [ ] Add isPublished (Boolean, default true)
  - [ ] Add timestamps (createdAt, updatedAt)

- [ ] **Design RecipeStep Model** (AC: 1)
  - [ ] Define RecipeStep model
  - [ ] Add id (UUID)
  - [ ] Add recipeId (UUID, foreign key)
  - [ ] Add stepNumber (Int, required)
  - [ ] Add instruction (String, required)
  - [ ] Set relation to Recipe

- [ ] **Design RecipeIngredient Model** (AC: 1)
  - [ ] Define RecipeIngredient model
  - [ ] Add id (UUID)
  - [ ] Add recipeId (UUID, foreign key)
  - [ ] Add label (String, required)
  - [ ] Set relation to Recipe

- [ ] **Design Category Model** (AC: 1)
  - [ ] Define Category model
  - [ ] Add id (Int, auto-increment)
  - [ ] Add name (String, unique)
  - [ ] Set relation to RecipeCategory

- [ ] **Design RecipeCategory Junction Table** (AC: 1, 2)
  - [ ] Define RecipeCategory model
  - [ ] Add id (UUID)
  - [ ] Add recipeId (UUID, foreign key)
  - [ ] Add categoryId (Int, foreign key)
  - [ ] Add unique constraint on (recipeId, categoryId)
  - [ ] Set relations to Recipe and Category

- [ ] **Configure Relationships** (AC: 2)
  - [ ] Add User → Recipe relation (one-to-many)
  - [ ] Add Recipe → RecipeStep relation (one-to-many, cascade delete)
  - [ ] Add Recipe → RecipeIngredient relation (one-to-many, cascade delete)
  - [ ] Add Recipe ↔ Category many-to-many via RecipeCategory
  - [ ] Test cascade delete behavior

- [ ] **Add Database Indexes** (AC: 3)
  - [ ] Add index on Recipe.title for search
  - [ ] Add index on Recipe.ownerId for user's recipes
  - [ ] Add index on Recipe.avgRating for sorting
  - [ ] Add index on Recipe.createdAt for sorting
  - [ ] Add index on RecipeStep.recipeId
  - [ ] Add index on RecipeIngredient.recipeId

- [ ] **Configure Full-Text Search** (AC: 4)
  - [ ] Enable PostgreSQL extensions (pg_trgm)
  - [ ] Add full-text search index on Recipe.title
  - [ ] Add full-text search index on Recipe.description
  - [ ] Test search functionality

- [ ] **Create Migration** (AC: 5)
  - [ ] Run `pnpm prisma migrate dev --name add_recipe_models`
  - [ ] Verify migration file created
  - [ ] Apply migration to database
  - [ ] Verify all tables created correctly

- [ ] **Create Seed Data Script** (AC: 6)
  - [ ] Update `prisma/seed.ts`
  - [ ] Add sample categories: ของหวาน, อาหารเช้า, อาหารกลางวัน, อาหารเย็น, ของว่าง, เครื่องดื่ม
  - [ ] Run seed script: `pnpm prisma db seed`
  - [ ] Verify categories created in database

- [ ] **Test Schema** (AC: 1-5)
  - [ ] Test creating recipe with relations
  - [ ] Test cascade delete (delete recipe, verify steps/ingredients deleted)
  - [ ] Test many-to-many relationship with categories
  - [ ] Verify indexes exist using database tools
  - [ ] Test full-text search queries

---

## Dev Notes

### Previous Story Insights

[Dependency: Epic 2 - Authentication & User System]

Epic 2 established:

- User model with authentication
- User relationships ready for recipes

This story creates the complete recipe data model.

### Prisma Schema Structure

[Source: prd/epic-3-recipe-management.md#story-3.1]

**Complete schema:**

```prisma
model Recipe {
  id             String   @id @default(uuid()) @db.Uuid
  ownerId        String   @db.Uuid
  title          String
  description    String?  @db.Text
  coverImageUrl  String?
  cookTimeMinutes Int
  avgRating      Decimal  @default(0) @db.Decimal(3, 2)
  ratingsCount   Int      @default(0)
  isPublished    Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner       User               @relation(fields: [ownerId], references: [id])
  steps       RecipeStep[]
  ingredients RecipeIngredient[]
  categories  RecipeCategory[]
  reviews     Review[]

  @@index([title])
  @@index([ownerId])
  @@index([avgRating])
  @@index([createdAt])
  @@map("recipes")
}

model RecipeStep {
  id          String @id @default(uuid()) @db.Uuid
  recipeId    String @db.Uuid
  stepNumber  Int
  instruction String @db.Text

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_steps")
}

model RecipeIngredient {
  id       String @id @default(uuid()) @db.Uuid
  recipeId String @db.Uuid
  label    String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_ingredients")
}

model Category {
  id      Int              @id @default(autoincrement())
  name    String           @unique
  recipes RecipeCategory[]

  @@map("categories")
}

model RecipeCategory {
  id         String @id @default(uuid()) @db.Uuid
  recipeId   String @db.Uuid
  categoryId Int

  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([recipeId, categoryId])
  @@index([recipeId])
  @@index([categoryId])
  @@map("recipe_categories")
}
```

### Cascade Delete Configuration

[Source: prd/epic-3-recipe-management.md#story-3.1]

**Cascade delete ensures:**

- When recipe is deleted, all related steps are deleted
- When recipe is deleted, all related ingredients are deleted
- When recipe is deleted, all category links are deleted
- Reviews will also be deleted (configured in Epic 5)

### Database Indexes Strategy

[Source: architecture/tech-stack.md#postgresql-15]

**Index purposes:**

- `Recipe.title`: For search queries
- `Recipe.ownerId`: For "my recipes" queries
- `Recipe.avgRating`: For sorting by popularity
- `Recipe.createdAt`: For sorting by latest
- `RecipeStep.recipeId`: For joining steps
- `RecipeIngredient.recipeId`: For joining ingredients

### Full-Text Search Setup

[Source: architecture/tech-stack.md#postgresql-15]

**PostgreSQL full-text search:**

```sql
-- Enable extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Create GIN index for full-text search
CREATE INDEX recipe_title_search_idx ON recipes USING gin(to_tsvector('english', title));
CREATE INDEX recipe_description_search_idx ON recipes USING gin(to_tsvector('english', description));
```

**Usage in queries:**

```typescript
const recipes = await prisma.$queryRaw`
  SELECT * FROM recipes
  WHERE to_tsvector('english', title || ' ' || COALESCE(description, ''))
  @@ plainto_tsquery('english', ${searchQuery})
`
```

### Seed Data Script

[Source: prd/epic-3-recipe-management.md#story-3.1]

**Update prisma/seed.ts:**

```typescript
async function main() {
  // Seed categories
  const categories = ['ของหวาน', 'อาหารเช้า', 'อาหารกลางวัน', 'อาหารเย็น', 'ของว่าง', 'เครื่องดื่ม']

  for (const name of categories) {
    await prisma.category.upsert({
      where: { name },
      update: {},
      create: { name },
    })
  }

  console.log('Seeded categories:', categories)
}
```

### Data Types

[Source: architecture/coding-standards.md#typescript-best-practices]

**Field types:**

- `avgRating`: Decimal(3,2) - allows 0.00 to 9.99
- `cookTimeMinutes`: Int - positive integer
- `isPublished`: Boolean - for draft/published state
- `description`: Text - for long content

### Testing

Manual testing required:

1. Verify migration creates all tables
2. Test creating recipe with Prisma Client
3. Test cascade delete behavior
4. Verify indexes exist in database
5. Test full-text search queries
6. Verify seed data created

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
