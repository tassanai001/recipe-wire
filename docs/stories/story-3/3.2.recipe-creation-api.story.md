# Story 3.2: Recipe Creation API

**Epic:** Epic 3 - Recipe Management  
**Story ID:** 3.2  
**Priority:** High  
**Estimate:** 5 Story Points  
**Sprint:** Sprint 4-6 (Week 5-8)

---

## Status

**Draft**

---

## Story

**As a** logged-in user,  
**I want** to create a new recipe via API,  
**so that** I can share my recipes with others

---

## Acceptance Criteria

1. `POST /v1/recipes` endpoint created (protected)
2. Request body validation: title (3-200 chars), description (max 2000 chars), coverImageUrl (valid URL), cookTimeMinutes (positive int), ingredients (array, min 1), steps (array, min 1), categoryIds (optional array)
3. Business logic: Create recipe with ownerId, create ingredients, create steps with auto-incremented stepNumber, link categories
4. Response: 201 status with complete recipe object including all relations
5. Error handling: 401 unauthenticated, 400 validation errors, 404 invalid category IDs
6. Unit tests cover validation and business logic
7. Integration test verifies database records

---

## Tasks / Subtasks

- [ ] **Create Recipe DTOs** (AC: 2)
  - [ ] Create `src/recipes/dto/create-recipe.dto.ts`
  - [ ] Define CreateRecipeSchema in @recipe-wire/types with Zod
  - [ ] Add validation for all fields
  - [ ] Export DTO

- [ ] **Generate Recipes Module** (AC: 1)
  - [ ] Run `nest g module recipes`
  - [ ] Run `nest g controller recipes`
  - [ ] Run `nest g service recipes`
  - [ ] Import RecipesModule in AppModule

- [ ] **Implement Recipe Creation Logic** (AC: 3, 4)
  - [ ] Inject PrismaService in RecipesService
  - [ ] Create `create` method accepting CreateRecipeDto and userId
  - [ ] Use Prisma transaction for atomic creation
  - [ ] Create recipe record with ownerId
  - [ ] Create ingredient records
  - [ ] Create step records with stepNumber
  - [ ] Link categories if provided
  - [ ] Return recipe with all relations

- [ ] **Implement Recipes Controller** (AC: 1, 5)
  - [ ] Create POST /recipes endpoint
  - [ ] Use @CurrentUser() decorator
  - [ ] Call recipesService.create()
  - [ ] Return 201 Created
  - [ ] Handle errors appropriately

- [ ] **Add Category Validation** (AC: 5)
  - [ ] Validate categoryIds exist in database
  - [ ] Throw NotFoundException if invalid
  - [ ] Handle empty categoryIds array

- [ ] **Create Unit Tests** (AC: 6)
  - [ ] Test recipe creation with valid data
  - [ ] Test validation errors
  - [ ] Test category validation
  - [ ] Mock PrismaService

- [ ] **Create Integration Tests** (AC: 7)
  - [ ] Test POST /v1/recipes with valid data
  - [ ] Verify recipe created in database
  - [ ] Verify ingredients created
  - [ ] Verify steps created with correct order
  - [ ] Verify categories linked
  - [ ] Test authentication required

---

## Dev Notes

### Previous Story Insights

[Dependency: Story 3.1 - Recipe Data Model]

Story 3.1 established:

- Complete recipe schema with relations
- Cascade delete configuration
- Database indexes

This story implements recipe creation API.

### Create Recipe DTO

[Source: prd/epic-3-recipe-management.md#story-3.2]

```typescript
export const CreateRecipeSchema = z.object({
  title: z.string().min(3).max(200),
  description: z.string().max(2000).optional(),
  coverImageUrl: z.string().url().optional(),
  cookTimeMinutes: z.number().int().positive(),
  ingredients: z.array(z.string()).min(1),
  steps: z.array(z.string()).min(1),
  categoryIds: z.array(z.number().int()).optional(),
})
```

### Recipe Service Implementation

[Source: architecture/coding-standards.md#nestjs-best-practices]

```typescript
async create(dto: CreateRecipeDto, userId: string) {
  // Validate categories
  if (dto.categoryIds?.length) {
    const categories = await this.prisma.category.findMany({
      where: { id: { in: dto.categoryIds } }
    })
    if (categories.length !== dto.categoryIds.length) {
      throw new NotFoundException('Invalid category IDs')
    }
  }

  // Create recipe with transaction
  return this.prisma.$transaction(async (tx) => {
    const recipe = await tx.recipe.create({
      data: {
        title: dto.title,
        description: dto.description,
        coverImageUrl: dto.coverImageUrl,
        cookTimeMinutes: dto.cookTimeMinutes,
        ownerId: userId,
        ingredients: {
          create: dto.ingredients.map((label) => ({ label }))
        },
        steps: {
          create: dto.steps.map((instruction, index) => ({
            stepNumber: index + 1,
            instruction
          }))
        },
        categories: dto.categoryIds
          ? {
              create: dto.categoryIds.map((categoryId) => ({
                categoryId
              }))
            }
          : undefined
      },
      include: {
        ingredients: true,
        steps: { orderBy: { stepNumber: 'asc' } },
        categories: { include: { category: true } },
        owner: { select: { id: true, displayName: true, avatarUrl: true } }
      }
    })

    return recipe
  })
}
```

### Testing

Integration test example:

```typescript
it('should create recipe with all relations', async () => {
  const { accessToken } = await login()

  const response = await request(app.getHttpServer())
    .post('/v1/recipes')
    .set('Authorization', `Bearer ${accessToken}`)
    .send({
      title: 'Pad Thai',
      description: 'Classic Thai noodle dish',
      cookTimeMinutes: 30,
      ingredients: ['Rice noodles', 'Shrimp', 'Egg'],
      steps: ['Soak noodles', 'Stir fry', 'Serve'],
      categoryIds: [1, 2],
    })
    .expect(201)

  expect(response.body.title).toBe('Pad Thai')
  expect(response.body.ingredients).toHaveLength(3)
  expect(response.body.steps).toHaveLength(3)
  expect(response.body.categories).toHaveLength(2)
})
```

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
