# Story 1.6: Setup Local File Upload Infrastructure

**Epic:** Epic 1 - Project Setup & Infrastructure  
**Story ID:** 1.6  
**Priority:** Medium  
**Estimate:** 3 Story Points  
**Sprint:** Sprint 1 (Week 1-2)

---

## Status

**Draft**

---

## Story

**As a** developer,  
**I want** a local file upload system configured,  
**so that** users can upload recipe and profile images

---

## Acceptance Criteria

1. Upload directory created: `/var/app/uploads` (or `./uploads` in dev)
2. Directory structure organized by type:
   - `uploads/recipes/` - Recipe images
   - `uploads/profiles/` - Profile images
3. Upload directory mounted in Docker Compose
4. File upload middleware configured in NestJS
5. File validation implemented:
   - Allowed types: `image/jpeg`, `image/png`, `image/webp`
   - Max size: 3 MB per file
   - Filename sanitization (prevent path traversal)
6. Static file serving configured for uploads
7. Environment variable for upload path configured

---

## Tasks / Subtasks

- [ ] **Create Upload Directory Structure** (AC: 1, 2)
  - [ ] Create `uploads/` directory in project root
  - [ ] Create `uploads/recipes/` subdirectory
  - [ ] Create `uploads/profiles/` subdirectory
  - [ ] Add `.gitkeep` files to preserve empty directories
  - [ ] Add `uploads/*` to .gitignore (except .gitkeep)

- [ ] **Update Docker Compose Configuration** (AC: 3)
  - [ ] Add uploads volume mount to docker-compose.yml
  - [ ] Mount `./uploads:/var/app/uploads` in api service
  - [ ] Ensure proper permissions for uploads directory
  - [ ] Test volume mount works (create file and verify)

- [ ] **Install Multer Dependencies** (AC: 4)
  - [ ] Navigate to `apps/backend/`
  - [ ] Install multer: `pnpm add multer`
  - [ ] Install types: `pnpm add -D @types/multer`
  - [ ] Verify installations in package.json

- [ ] **Configure Upload Path Environment Variable** (AC: 7)
  - [ ] Add `UPLOAD_PATH=/var/app/uploads` to .env
  - [ ] Add `UPLOAD_PATH` to .env.example
  - [ ] Update ConfigModule validation to include UPLOAD_PATH
  - [ ] Document upload path in README

- [ ] **Create Uploads Module** (AC: 4)
  - [ ] Generate uploads module: `nest g module uploads`
  - [ ] Generate uploads controller: `nest g controller uploads`
  - [ ] Generate uploads service: `nest g service uploads`
  - [ ] Import UploadsModule in AppModule

- [ ] **Configure Multer Storage** (AC: 4, 5)
  - [ ] Create `src/uploads/config/multer.config.ts`
  - [ ] Configure diskStorage with destination and filename
  - [ ] Generate unique filenames: `{uuid}-{timestamp}.{ext}`
  - [ ] Set destination based on upload type (recipes/profiles)
  - [ ] Export multer configuration

- [ ] **Implement File Validation** (AC: 5)
  - [ ] Create file filter function for MIME type validation
  - [ ] Allow only: image/jpeg, image/png, image/webp
  - [ ] Set max file size to 3 MB (3 * 1024 * 1024 bytes)
  - [ ] Create custom exception for invalid files
  - [ ] Add filename sanitization to prevent path traversal

- [ ] **Create File Upload Interceptor** (AC: 4, 5)
  - [ ] Create `src/uploads/interceptors/file-validation.interceptor.ts`
  - [ ] Validate file extension matches MIME type
  - [ ] Check file size before processing
  - [ ] Sanitize filename (remove special characters)
  - [ ] Throw BadRequestException for invalid files

- [ ] **Implement Upload Endpoints** (AC: 4)
  - [ ] Create POST /uploads/recipe endpoint
  - [ ] Create POST /uploads/profile endpoint
  - [ ] Use @UseInterceptors(FileInterceptor('file'))
  - [ ] Apply file validation interceptor
  - [ ] Return uploaded file URL in response

- [ ] **Configure Static File Serving** (AC: 6)
  - [ ] Configure Express static middleware in main.ts
  - [ ] Serve uploads directory at /uploads route
  - [ ] Set proper MIME types for images
  - [ ] Add cache headers for static files
  - [ ] Test file access via URL

- [ ] **Create Uploads Service** (AC: 4, 5)
  - [ ] Implement saveFile method with type parameter
  - [ ] Implement deleteFile method for cleanup
  - [ ] Implement getFileUrl method
  - [ ] Add error handling for file operations
  - [ ] Add logging for upload events

- [ ] **Add File Cleanup Utilities** (AC: 4)
  - [ ] Create method to delete old files
  - [ ] Create method to validate file exists
  - [ ] Add error handling for missing files
  - [ ] Document cleanup procedures

- [ ] **Create Upload DTOs** (AC: 4)
  - [ ] Create UploadResponseDto with url, filename, size
  - [ ] Create FileUploadDto for validation
  - [ ] Add Zod schemas for validation
  - [ ] Export DTOs from uploads module

- [ ] **Test File Upload System** (AC: 1-7)
  - [ ] Test upload recipe image via POST /uploads/recipe
  - [ ] Test upload profile image via POST /uploads/profile
  - [ ] Verify file saved to correct directory
  - [ ] Verify unique filename generated
  - [ ] Test file accessible via /uploads/recipes/{filename}
  - [ ] Test file validation (invalid type rejected)
  - [ ] Test file size limit (>3MB rejected)
  - [ ] Test filename sanitization (special chars removed)
  - [ ] Verify uploads persist after Docker restart

---

## Dev Notes

### Previous Story Insights
[Dependency: Story 1.4 - Setup NestJS Backend Skeleton]

Story 1.4 established:
- NestJS application with modular structure
- Environment configuration with ConfigModule
- Global validation pipe
- Logging with Pino

This story adds file upload capability to the API.

[Dependency: Story 1.2 - Setup Docker Development Environment]

Story 1.2 established:
- Docker Compose configuration
- Volume mounts for source code and database

This story adds uploads volume mount.

### Multer Configuration
[Source: architecture/tech-stack.md#multer-1.4]

**Multer 1.4+** for file upload handling:
- Version: 1.4.5 or later
- Handles multipart/form-data
- Flexible storage options (disk, memory)
- File filtering and size limits

**Installation:**
```bash
pnpm add multer
pnpm add -D @types/multer
```

### Upload Directory Structure
[Source: prd/epic-1-project-setup.md#story-1.6]

**Directory organization:**
```
uploads/
├── recipes/          # Recipe images
│   └── {uuid}-{timestamp}.jpg
└── profiles/         # Profile images
    └── {uuid}-{timestamp}.png
```

**Development path:** `./uploads`  
**Production path:** `/var/app/uploads`

### Multer Storage Configuration
[Source: architecture/tech-stack.md#multer-1.4]

**Storage configuration (src/uploads/config/multer.config.ts):**
```typescript
import { diskStorage } from 'multer'
import { extname } from 'path'
import { v4 as uuidv4 } from 'uuid'

export const multerConfig = {
  storage: diskStorage({
    destination: (req, file, cb) => {
      const uploadPath = process.env.UPLOAD_PATH || './uploads'
      const type = req.params.type || 'recipes' // recipes or profiles
      cb(null, `${uploadPath}/${type}`)
    },
    filename: (req, file, cb) => {
      const uniqueName = `${uuidv4()}-${Date.now()}${extname(file.originalname)}`
      cb(null, uniqueName)
    }
  }),
  fileFilter: (req, file, cb) => {
    const allowedMimes = ['image/jpeg', 'image/png', 'image/webp']
    if (allowedMimes.includes(file.mimetype)) {
      cb(null, true)
    } else {
      cb(new Error('Invalid file type. Only JPEG, PNG, and WebP are allowed.'), false)
    }
  },
  limits: {
    fileSize: 3 * 1024 * 1024 // 3 MB
  }
}
```

### File Upload Endpoint Implementation
[Source: architecture/source-tree.md#backend-structure]

**UploadsController:**
```typescript
import { Controller, Post, UseInterceptors, UploadedFile, Param, BadRequestException } from '@nestjs/common'
import { FileInterceptor } from '@nestjs/platform-express'
import { multerConfig } from './config/multer.config'
import { UploadsService } from './uploads.service'

@Controller('uploads')
export class UploadsController {
  constructor(private uploadsService: UploadsService) {}

  @Post(':type')
  @UseInterceptors(FileInterceptor('file', multerConfig))
  async uploadFile(
    @Param('type') type: string,
    @UploadedFile() file: Express.Multer.File
  ) {
    if (!file) {
      throw new BadRequestException('No file uploaded')
    }

    if (!['recipes', 'profiles'].includes(type)) {
      throw new BadRequestException('Invalid upload type')
    }

    const fileUrl = this.uploadsService.getFileUrl(type, file.filename)

    return {
      url: fileUrl,
      filename: file.filename,
      size: file.size,
      mimetype: file.mimetype
    }
  }
}
```

### File Validation
[Source: prd/epic-1-project-setup.md#story-1.6]

**Validation requirements:**
- **Allowed MIME types:** `image/jpeg`, `image/png`, `image/webp`
- **Max file size:** 3 MB (3,145,728 bytes)
- **Filename sanitization:** Remove special characters, prevent path traversal

**Filename sanitization:**
```typescript
function sanitizeFilename(filename: string): string {
  return filename
    .replace(/[^a-zA-Z0-9.-]/g, '_') // Replace special chars
    .replace(/\.{2,}/g, '.') // Prevent path traversal (..)
    .toLowerCase()
}
```

### Static File Serving
[Source: prd/epic-1-project-setup.md#story-1.6]

**Configure in main.ts:**
```typescript
import { NestFactory } from '@nestjs/core'
import { NestExpressApplication } from '@nestjs/platform-express'
import { join } from 'path'
import { AppModule } from './app.module'

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule)

  // Serve static files
  const uploadPath = process.env.UPLOAD_PATH || './uploads'
  app.useStaticAssets(uploadPath, {
    prefix: '/uploads/',
    maxAge: '1d' // Cache for 1 day
  })

  await app.listen(3001)
}
bootstrap()
```

**File URL format:**
```
http://localhost:3001/uploads/recipes/{uuid}-{timestamp}.jpg
http://localhost:3001/uploads/profiles/{uuid}-{timestamp}.png
```

### Uploads Service Implementation
[Source: architecture/source-tree.md#backend-module-pattern]

**UploadsService:**
```typescript
import { Injectable, Logger } from '@nestjs/common'
import { ConfigService } from '@nestjs/config'
import { unlink } from 'fs/promises'
import { join } from 'path'

@Injectable()
export class UploadsService {
  private readonly logger = new Logger(UploadsService.name)
  private readonly uploadPath: string

  constructor(private configService: ConfigService) {
    this.uploadPath = this.configService.get<string>('UPLOAD_PATH') || './uploads'
  }

  getFileUrl(type: string, filename: string): string {
    const baseUrl = this.configService.get<string>('API_BASE_URL') || 'http://localhost:3001'
    return `${baseUrl}/uploads/${type}/${filename}`
  }

  async deleteFile(type: string, filename: string): Promise<void> {
    try {
      const filePath = join(this.uploadPath, type, filename)
      await unlink(filePath)
      this.logger.log(`Deleted file: ${filePath}`)
    } catch (error) {
      this.logger.error(`Failed to delete file: ${error.message}`)
      throw error
    }
  }
}
```

### Docker Compose Volume Mount
[Source: prd/epic-1-project-setup.md#story-1.6]

**Update docker-compose.yml:**
```yaml
services:
  api:
    # ... other config
    volumes:
      - ./apps/backend:/app
      - /app/node_modules
      - ./uploads:/var/app/uploads  # Add this line
    environment:
      UPLOAD_PATH: /var/app/uploads
```

### Security Considerations
[Source: architecture/coding-standards.md#security-best-practices]

**File upload security:**
1. **Validate MIME type** - Check file.mimetype
2. **Validate file extension** - Check file extension matches MIME type
3. **Limit file size** - Prevent large file uploads
4. **Sanitize filename** - Remove special characters, prevent path traversal
5. **Generate unique filenames** - Use UUID to prevent overwrites
6. **Validate file content** - Consider using file-type library for deep validation (future enhancement)

**Path traversal prevention:**
```typescript
// ❌ Bad - vulnerable to path traversal
const filename = req.body.filename // Could be "../../etc/passwd"

// ✅ Good - sanitized and unique
const filename = `${uuidv4()}-${Date.now()}${extname(file.originalname)}`
```

### Environment Variables
[Source: prd/epic-1-project-setup.md#story-1.6]

**Add to .env:**
```
UPLOAD_PATH=/var/app/uploads
API_BASE_URL=http://localhost:3001
```

**Add to .env.example:**
```
# File Upload Configuration
UPLOAD_PATH=/var/app/uploads
API_BASE_URL=http://localhost:3001
```

### File Structure
[Source: architecture/source-tree.md#backend-structure]

**Uploads module structure:**
```
apps/backend/src/uploads/
├── config/
│   └── multer.config.ts       # Multer configuration
├── interceptors/
│   └── file-validation.interceptor.ts
├── dto/
│   ├── upload-response.dto.ts
│   └── file-upload.dto.ts
├── uploads.controller.ts
├── uploads.service.ts
└── uploads.module.ts
```

### Testing

[Source: architecture/coding-standards.md#testing-standards]

**Manual Testing Required:**
1. Verify uploads directory exists: `./uploads/recipes/`, `./uploads/profiles/`
2. Verify Docker volume mount: Check docker-compose.yml
3. Start API: `pnpm start:dev`
4. Test recipe upload:
   ```bash
   curl -X POST http://localhost:3001/uploads/recipes \
     -F "file=@test-image.jpg"
   ```
5. Verify response includes: url, filename, size, mimetype
6. Verify file saved to `uploads/recipes/` directory
7. Test file accessible: Open URL in browser
8. Test profile upload: Same as recipe upload with `/uploads/profiles`
9. Test invalid file type (e.g., .txt file) - should return 400 error
10. Test file size limit (upload >3MB file) - should return 400 error
11. Test filename sanitization (upload file with special chars)
12. Restart Docker containers and verify uploads persist

**No automated tests required** for this infrastructure story. Integration tests will be added in Epic 6.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent during implementation_

### Debug Log References
_To be filled by Dev Agent during implementation_

### Completion Notes List
_To be filled by Dev Agent during implementation_

### File List
_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
