# Story 1.2: Setup Docker Development Environment

**Epic:** Epic 1 - Project Setup & Infrastructure  
**Story ID:** 1.2  
**Priority:** High  
**Estimate:** 5 Story Points  
**Sprint:** Sprint 1 (Week 1-2)

---

## Status

**Draft**

---

## Story

**As a** developer,  
**I want** a Docker Compose setup for local development,  
**so that** I can run the entire stack (frontend, backend, database) consistently across different machines

---

## Acceptance Criteria

1. `docker-compose.yml` created with services:
   - `db` - PostgreSQL 15+
   - `api` - NestJS backend (development mode with hot reload)
   - `frontend` - Next.js frontend (development mode with hot reload)
2. Volume mounts configured for:
   - Database data persistence
   - Source code (for hot reload)
   - Uploads folder (`/var/app/uploads`)
3. Environment variables configured via `.env` files
4. Health checks configured for all services
5. Services can communicate via Docker network
6. Documentation in `README.md` for running Docker setup

---

## Tasks / Subtasks

- [ ] **Create Docker Compose Configuration** (AC: 1)
  - [ ] Create `docker-compose.yml` in project root
  - [ ] Define PostgreSQL service with postgres:15-alpine image
  - [ ] Define API service with node:20-alpine base image
  - [ ] Define frontend service with node:20-alpine base image
  - [ ] Configure Docker network for service communication

- [ ] **Configure PostgreSQL Service** (AC: 1, 2, 4)
  - [ ] Set PostgreSQL environment variables (POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB)
  - [ ] Map port 5432 to host
  - [ ] Create volume for database data persistence: `postgres_data:/var/lib/postgresql/data`
  - [ ] Add health check using `pg_isready` command
  - [ ] Set restart policy to `unless-stopped`

- [ ] **Configure Backend API Service** (AC: 1, 2, 4, 5)
  - [ ] Set working directory to `/app`
  - [ ] Mount source code: `./apps/backend:/app` (for hot reload)
  - [ ] Mount node_modules as volume to prevent conflicts
  - [ ] Map port 3001 to host
  - [ ] Set environment variables for database connection
  - [ ] Add health check for `/health` endpoint
  - [ ] Configure depends_on with db service
  - [ ] Set command: `pnpm install && pnpm dev`

- [ ] **Configure Frontend Service** (AC: 1, 2, 4, 5)
  - [ ] Set working directory to `/app`
  - [ ] Mount source code: `./apps/frontend:/app` (for hot reload)
  - [ ] Mount node_modules as volume
  - [ ] Map port 3000 to host
  - [ ] Set NEXT_PUBLIC_API_URL environment variable
  - [ ] Add health check for Next.js
  - [ ] Configure depends_on with api service
  - [ ] Set command: `pnpm install && pnpm dev`

- [ ] **Configure Uploads Volume** (AC: 2)
  - [ ] Create uploads volume mount: `./uploads:/var/app/uploads`
  - [ ] Ensure uploads directory is created on host
  - [ ] Set proper permissions for uploads directory
  - [ ] Mount uploads in both api and frontend services (if needed)

- [ ] **Setup Environment Variables** (AC: 3)
  - [ ] Create `.env.example` in project root with all required variables
  - [ ] Document DATABASE_URL format
  - [ ] Document JWT_SECRET, JWT_REFRESH_SECRET
  - [ ] Document NEXT_PUBLIC_API_URL
  - [ ] Add `.env` to .gitignore (if not already)
  - [ ] Create instructions for copying .env.example to .env

- [ ] **Create Development Dockerfiles** (AC: 1)
  - [ ] Create `apps/backend/Dockerfile` for development
  - [ ] Create `apps/frontend/Dockerfile` for development
  - [ ] Use multi-stage builds for optimization
  - [ ] Install pnpm in Docker images
  - [ ] Configure proper user permissions

- [ ] **Update Documentation** (AC: 6)
  - [ ] Add "Getting Started" section to README.md
  - [ ] Document prerequisites (Docker, Docker Compose)
  - [ ] Document how to start services: `docker-compose up`
  - [ ] Document how to stop services: `docker-compose down`
  - [ ] Document how to view logs: `docker-compose logs -f [service]`
  - [ ] Document port mappings and access URLs
  - [ ] Add troubleshooting section for common issues

- [ ] **Test Docker Setup** (AC: 1-6)
  - [ ] Run `docker-compose up` and verify all services start
  - [ ] Verify database is accessible on localhost:5432
  - [ ] Verify API is accessible on localhost:3001
  - [ ] Verify frontend is accessible on localhost:3000
  - [ ] Test hot reload by modifying source files
  - [ ] Verify services can communicate (API can connect to DB)
  - [ ] Test health checks are working
  - [ ] Verify uploads directory is writable

---

## Dev Notes

### Previous Story Insights

[Dependency: Story 1.1 - Initialize Monorepo Structure]

Story 1.1 established the monorepo structure with:

- pnpm workspaces configured
- apps/backend/ and apps/frontend/ directories created
- Root package.json with workspace scripts

This story builds on that foundation by containerizing the development environment.

### Docker Configuration Overview

[Source: architecture/tech-stack.md#docker-24]

**Docker 24+** and **Docker Compose 2+** are required:

- Application containerization for consistent environments
- Multi-container orchestration for local development
- Images to use:
  - `node:18-alpine` or `node:20-alpine` for Node.js services
  - `postgres:15-alpine` for PostgreSQL
  - `nginx:alpine` for production (not in this story)

### Port Mappings

[Source: prd/epic-1-project-setup.md#story-1.2]

Standard port configuration:

- **PostgreSQL:** 5432 (mapped to host)
- **API (Backend):** 3001 (mapped to host)
- **Frontend:** 3000 (mapped to host)

### Volume Mount Strategy

[Source: architecture/source-tree.md#docker-structure]

**Development volumes:**

```yaml
volumes:
  # Database persistence
  - postgres_data:/var/lib/postgresql/data

  # Source code (hot reload)
  - ./apps/backend:/app
  - ./apps/frontend:/app

  # Uploads
  - ./uploads:/var/app/uploads

  # Prevent node_modules conflicts
  - /app/node_modules
```

### Environment Variables Configuration

[Source: prd/epic-1-project-setup.md#story-1.2]

Required environment variables for `.env.example`:

**Database:**

```
POSTGRES_USER=recipewire
POSTGRES_PASSWORD=dev_password_change_in_prod
POSTGRES_DB=recipewire_dev
DATABASE_URL=postgresql://recipewire:dev_password_change_in_prod@db:5432/recipewire_dev
```

**Backend API:**

```
NODE_ENV=development
PORT=3001
JWT_SECRET=your-jwt-secret-change-in-prod
JWT_REFRESH_SECRET=your-refresh-secret-change-in-prod
JWT_ACCESS_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d
UPLOAD_PATH=/var/app/uploads
```

**Frontend:**

```
NEXT_PUBLIC_API_URL=http://localhost:3001
```

### Docker Compose Service Configuration

[Source: architecture/tech-stack.md#docker-compose-2]

**Basic service structure:**

```yaml
version: '3.8'

services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    working_dir: /app
    command: sh -c "pnpm install && pnpm dev"
    ports:
      - '3001:3001'
    volumes:
      - ./apps/backend:/app
      - /app/node_modules
    environment:
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    working_dir: /app
    command: sh -c "pnpm install && pnpm dev"
    ports:
      - '3000:3000'
    volumes:
      - ./apps/frontend:/app
      - /app/node_modules
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    depends_on:
      - api
    restart: unless-stopped

volumes:
  postgres_data:
```

### Development Dockerfile Structure

[Source: architecture/source-tree.md#docker-structure]

**Backend Dockerfile (apps/backend/Dockerfile):**

```dockerfile
FROM node:20-alpine

# Install pnpm
RUN npm install -g pnpm@8

WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml* ./

# Install dependencies will happen via command in docker-compose
# This allows for hot reload

EXPOSE 3001

CMD ["pnpm", "dev"]
```

**Frontend Dockerfile (apps/frontend/Dockerfile):**

```dockerfile
FROM node:20-alpine

# Install pnpm
RUN npm install -g pnpm@8

WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml* ./

EXPOSE 3000

CMD ["pnpm", "dev"]
```

### Health Check Configuration

[Source: architecture/tech-stack.md#docker-24]

**PostgreSQL health check:**

```yaml
healthcheck:
  test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
  interval: 10s
  timeout: 5s
  retries: 5
```

**API health check (after Story 1.4 implements /health endpoint):**

```yaml
healthcheck:
  test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3001/health']
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### Cross-Platform Compatibility

[Source: prd/epic-1-project-setup.md#risks-mitigations]

**Risk:** Docker setup issues on different OS (Windows, macOS, Linux)

**Mitigations:**

- Use bind mounts with relative paths (./apps/backend)
- Document Windows-specific issues (line endings, path separators)
- Use alpine images for smaller size and consistency
- Test on at least 2 different operating systems

### Hot Reload Configuration

[Source: architecture/tech-stack.md#nestjs-10]

For hot reload to work:

- Source code must be mounted as volume
- node_modules should be a separate volume (prevents host/container conflicts)
- NestJS: Use `pnpm start:dev` or `nest start --watch`
- Next.js: Use `pnpm dev` (hot reload built-in)

### Testing

[Source: architecture/coding-standards.md#testing-standards]

**Manual Testing Required:**

1. Start services: `docker-compose up`
2. Verify all containers are running: `docker-compose ps`
3. Check logs for errors: `docker-compose logs`
4. Test database connection: `psql -h localhost -U recipewire -d recipewire_dev`
5. Test API accessibility: `curl http://localhost:3001/health` (after Story 1.4)
6. Test frontend accessibility: Open `http://localhost:3000` in browser
7. Test hot reload: Modify a source file and verify changes appear
8. Test service communication: API should connect to database
9. Test volume persistence: Stop containers, restart, verify data persists
10. Test on different OS if possible (Windows, macOS, Linux)

**No automated tests required** for this infrastructure story. Manual verification is sufficient.

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
